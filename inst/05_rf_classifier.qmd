---
title: "Random Forest Classification - Genre Discourse Analysis"
author: "Markus Radke"
date: "`r Sys.Date()`"
format: 
    html: 
        code-fold: true
        code-summary: "Show/Hide Code"
        output-dir: reports
        toc: true
        toc-location: left
        toc-depth: 5
        toc-expand: 5
        number-sections: true
        theme: cosmo
        code-links:
        - text: Github Repository
          href: "https://github.com/markusradke/GenreDiscourseAnalysis"
        css: 
          styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
devtools::load_all()

mb_train_low <- read_feather_with_lists("../models/classifier/rf_mb_lowres_train.feather")
mb_test_low <- read_feather_with_lists("../models/classifier/rf_mb_lowres_test.feather")
mb_train_high <- read_feather_with_lists("../models/classifier/rf_mb_highres_train.feather")
mb_test_high <- read_feather_with_lists("../models/classifier/rf_mb_highres_test.feather")

eval_mb_low <- readRDS("../models/classifier/rf_mb_lowres_eval.rds")
settings_mb_low <- readRDS("../models/classifier/rf_mb_lowres_settings.rds")
eval_mb_high <- readRDS("../models/classifier/rf_mb_highres_eval.rds")
settings_mb_high <- readRDS("../models/classifier/rf_mb_highres_settings.rds")
```

# Prototyping Random Forest Classifier for Community Metagenre Classification

This report presents the evaluation results of Random Forest classifiers trained to predict the MusicBrainz folksonomy metagenres. Classifiers were trained for both low detailed and high detailed metagenre taxonomies.

## Workflow

```{mermaid}
%%{init: {
  'flowchart': {
    'nodeSpacing': 50, 
    'rankSpacing': 80,
    'useMaxWidth': true,
    'htmlLabels': false,
    'curve': 'basis'
  }, 
  'theme': 'base',
  'themeVariables': {
    'fontSize': '16px',
    'fontFamily': 'Arial, sans-serif',
    'primaryColor': '#ffffff',
    'primaryTextColor': '#333333',
    'primaryBorderColor': '#cccccc', 
    'lineColor': '#666666',
    'textColor': '#333333'
  }
}}%%
graph TD
  A["POPTRAG"] --> B["select all potential features"]
  B --> C["transform characters to factors, apply heuristics to lyrics features"]
  C --> D["casewise deletion of excessive missing values (greater 40%)"]
  D --> E["join with metagenre target labels on specified detail level"]
  E --> F["subsample for prototypying (e.g., 20% of data, optional)"]
  F --> G["split into training and test set (80/20) on artist level to avoid data leakage"]
  G --> H["train random forest imputer model for missing values on train sets (optional)"]
  H --> I["impute missing values in training and test sets with corresponding imputation model (otional)"]
  I --> J["select predictors for modeling"]
  J --> K["undersample majority classes in training set to handle class imbalance (e.g., target class size = 10 * size of smallest class)"]
  K --> L["train initial random forest classifier on training sets (1k trees, mtry = sqrt(number of predictors), min.node.size = 1)"]
  L --> M["evaluate model performance on train and test sets (confusion matrix, accuracy, kappa, macro-F1, variable importance)"]
```

## Data sets

```{r dataset_summary}	
summarize_ds <- function(resolution, split, df) {
  data.frame(
    Metagenre_Resolution = resolution,
    Split = split,
    N_Tracks = format(nrow(df), big.mark = ","),
    N_Artists = format(nrow(dplyr::distinct(df, .data$artist.s.id)), big.mark = ",")
  )
}

datasets <- dplyr::bind_rows(
  summarize_ds("low (10-15)",  "Train", mb_train_low),
  summarize_ds("low (10-15)",  "Test",  mb_test_low),
  summarize_ds("high (25-30)", "Train", mb_train_high),
  summarize_ds("high (25-30)", "Test",  mb_test_high),
)

knitr::kable(
  datasets,
  col.names = c("Metagenre Resolution", "Split", "N~Tracks~", "N~Artists~"),
  caption = "Dataset splits used in the analyses"
)
```	

## Features used for classification

### List of potential features
```{r feature_list}	
cols <- setdiff(colnames(mb_test_low), "metagenre")
knitr::asis_output(paste0("- ", cols, collapse = "\n"))
```

### List of selected features after preprocessing and imputation

```{r selected_features mb low}
cols_mb_low <- eval_mb_low$varimp$Variable
knitr::asis_output(paste0("- ", cols_mb_low, collapse = "\n"))
```


# Model settings
```{r settings_mb_low}
knitr::kable(
  settings_mb_low |> as.data.frame(),
  caption = "Random Forest classifier settings for **low detailed** MusicBrainz metagenres (10-15)."
)
```

```{r settings_mb_high}
knitr::kable(
  settings_mb_high |> as.data.frame(),
  caption = "Random Forest classifier settings for **high detailed** MusicBrainz metagenres (25-30)."
)
```

# Results 
## Low detailed
```{r low_results_mb train}
#| fig.cap: "Confusion matrix and evaluation metrics for Random Forest classifier predicting low detailed MusicBrainz metagenres. Evaluated on **train set.**"
plot_cm(eval_mb_low$confusion_train, eval_mb_low$metrics_train)
```
```{r low_results_mb test}
#| fig.cap: "Confusion matrix and evaluation metrics for Random Forest classifier predicting low detailed MusicBrainz metagenres. Evaluated on **test set.**"
plot_cm(eval_mb_low$confusion_test, eval_mb_low$metrics_test)
```



```{r low_results_mb varimp}
#| fig.cap: "**Most important variables** for Random Forest classifier predicting low detailed MusicBrainz metagenres."
plot_varimp(eval_mb_low$varimp)
```


## High detailed
```{r high_results_mb cm train, fig.height=10, fig.width=12}
#| fig.cap: "Confusion matrix and evaluation metrics for Random Forest classifier predicting high detailed MusicBrainz metagenres. Evaluated on **train set.**"
plot_cm(eval_mb_high$confusion_train, eval_mb_high$metrics_train)
```
```{r high_results_mb cm test, fig.height=10, fig.width=12}
#| fig.cap: "Confusion matrix and evaluation metrics for Random Forest classifier predicting high detailed MusicBrainz metagenres. Evaluated on **test set.**"
plot_cm(eval_mb_high$confusion_test, eval_mb_high$metrics_test)
```

```{r high_results_mb varimp}
#| fig.cap: "**Most important variables** for Random Forest classifier predicting high detailed MusicBrainz metagenres."
plot_varimp(eval_mb_high$varimp)
```
